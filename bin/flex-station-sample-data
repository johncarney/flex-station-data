#!/usr/bin/env ruby

require "flex_station_data/services/load_plates"
require "flex_station_data/presenters/plates_csv"

require "pry"

module FlexStationData
  class SampleDataApp
    include Concerns::Service

    attr_reader :args

    def initialize(*args)
      @args = args
    end

    def files
      @files ||= args.map { |arg| Pathname(arg) }
    end

    def plates
      @plates ||= files.map do |file|
        [ file, LoadPlates.call(file) ]
      end
    end

    def csv
      plates.flat_map do |file, file_plates|
        Presenters::PlatesCsv.present(file, file_plates)
      end
    end

    def call
      CSV do |out|
        csv.each do |row|
          out << row
        end
      end
    end
  end
end

FlexStationData::SampleDataApp.call(*ARGV)
